.PHONY: setup destroy lint validate help

CLUSTER_NAME ?= glideinfra-eks
REGION ?= us-east-1

help:
	@echo "GlideInfra EKS Management Commands"
	@echo "--------------------------------"
	@echo "setup     : Setup a new EKS cluster in AWS"
	@echo "destroy   : Destroy the EKS cluster and all resources"
	@echo "validate  : Run terraform validate"
	@echo "lint      : Run terraform fmt to format code"
	@echo "status    : Check cluster status"
	@echo "help      : Show this help message"
	@echo ""
	@echo "Environment Variables:"
	@echo "CLUSTER_NAME : Name of the EKS cluster (default: glideinfra-eks)"
	@echo "REGION       : AWS region (default: us-east-1)"

setup:
	@chmod +x setup_glideinfra.sh
	@./setup_glideinfra.sh $(CLUSTER_NAME)

destroy:
	@chmod +x destroy_glideinfra.sh
	@./destroy_glideinfra.sh $(CLUSTER_NAME)

validate:
	@cd terraform && terraform validate

lint:
	@cd terraform && terraform fmt -recursive

status:
	@echo "Checking EKS cluster status for '$(CLUSTER_NAME)' in '$(REGION)'..."
	@aws eks describe-cluster --name $(CLUSTER_NAME) --region $(REGION) --query "cluster.status" || echo "Cluster not found or not accessible"
	@if aws eks describe-cluster --name $(CLUSTER_NAME) --region $(REGION) &> /dev/null; then \
		echo "Fetching nodes:"; \
		kubectl get nodes; \
	fi
